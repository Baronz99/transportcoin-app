// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  password        String
  tier            String    @default("BASIC")
  isAdmin         Boolean   @default(false)
  lastLoginAt     DateTime?
  acceptedTermsAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  profile            UserProfile?
  wallet             Wallet?
  transactions       Transaction[]
  withdrawalRequests WithdrawalRequest[]
  transportEvents    TransportEvent[]
  tcGoldPurchases    TcGoldPurchase[]
}

model UserProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  fullName String?
  phone    String?
  country  String?
  city     String?
  timezone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wallet {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  /// Internal transport balance (TCN)
  balance Int @default(0)

  /// Governance / unlock token (TCGold)
  tcGoldBalance Int @default(0)

  /// Withdrawable USD balance, stored in cents
  usableUsdCents Int @default(0)

  /// BTC address for TCGold purchases (can be shared or per user)
  btcDepositAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
}

model Transaction {
  id       Int    @id @default(autoincrement())
  userId   Int
  walletId Int
  user     User   @relation(fields: [userId], references: [id])
  wallet   Wallet @relation(fields: [walletId], references: [id])

  /// e.g. DEPOSIT, WITHDRAWAL, IMPORT_TO_USABLE, TCG_PURCHASE, ADJUSTMENT
  type String

  /// Amount in TCN units for now (you can extend later)
  amount Int

  status      String   @default("SUCCESS") // SUCCESS | PENDING | FAILED
  description String?
  adminNote   String?  // âœ… NEW: Admin note visible to user
  createdAt   DateTime @default(now())
}

model WithdrawalRequest {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  /// Asset + network used for real-world payout
  asset   String // BTC, ETH, USDT, USDC, BNB, etc.
  network String // BTC, ERC20, TRC20, BEP20, etc.
  address String

  /// For now we track the amount in TCN; later you can add USD fields
  amountTcn Int

  status    String   @default("PENDING") // PENDING | COMPLETED | REJECTED
  createdAt DateTime @default(now())
}

model TransportEvent {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  type             String
  label            String
  route            String?
  vehicleId        String?
  location         String?
  amountFuelLitres Int?
  amountTcn        Int?
  amountTcg        Int?

  createdAt DateTime @default(now())
}

model PlatformConfig {
  id                  Int     @id @default(1)
  withdrawalDelayDays Int     @default(3)
  btcDepositAddress   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Ledger for TCGold purchases funded via BTC
model TcGoldPurchase {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  /// TCG tokens the user intends to buy
  tcgAmount Int

  /// USD value at the time of request, stored in cents
  usdValueCents Int

  /// BTC address for this purchase (can match wallet.btcDepositAddress)
  btcAddress String

  /// BTC transaction ID once confirmed by ops / admin
  btcTxId String?

  /// PENDING | CONFIRMED | REJECTED
  status String @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
