// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  password        String
  tier            String    @default("BASIC")
  isAdmin         Boolean   @default(false)
  lastLoginAt     DateTime?
  acceptedTermsAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  profile            UserProfile?
  wallet             Wallet?
  transactions       Transaction[]
  withdrawalRequests WithdrawalRequest[]
  transportEvents    TransportEvent[]
  tcGoldPurchases    TcGoldPurchase[]

  // ✅ FIX: Opposite relation for SupportThread.user
  supportThreads     SupportThread[]
}

model UserProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  fullName String?
  phone    String?
  country  String?
  city     String?
  timezone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wallet {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  balance         Int @default(0)
  tcGoldBalance   Int @default(0)
  usableUsdCents  Int @default(0)
  btcDepositAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
}

model Transaction {
  id       Int    @id @default(autoincrement())
  userId   Int
  walletId Int
  user     User   @relation(fields: [userId], references: [id])
  wallet   Wallet @relation(fields: [walletId], references: [id])

  type   String
  amount Int

  status      String   @default("SUCCESS")
  description String?
  adminNote   String?  // ✅ Admin note visible to user
  createdAt   DateTime @default(now())
}

model WithdrawalRequest {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  asset   String
  network String
  address String
  amountTcn Int

  status    String   @default("PENDING")
  createdAt DateTime @default(now())

  // ✅ Optional 1:1 thread linked by SupportThread.withdrawalRequestId
  thread SupportThread?
}

model TransportEvent {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  type             String
  label            String
  route            String?
  vehicleId        String?
  location         String?
  amountFuelLitres Int?
  amountTcn        Int?
  amountTcg        Int?

  createdAt DateTime @default(now())
}

model PlatformConfig {
  id                  Int     @id @default(1)
  withdrawalDelayDays Int     @default(3)
  btcDepositAddress   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TcGoldPurchase {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  tcgAmount     Int
  usdValueCents Int
  btcAddress    String
  btcTxId       String?
  status        String @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SupportThread {
  id        Int      @id @default(autoincrement())

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  // Optional link to a withdrawal request (1:1)
  withdrawalRequestId Int? @unique
  withdrawalRequest   WithdrawalRequest? @relation(fields: [withdrawalRequestId], references: [id])

  status    String   @default("OPEN") // OPEN | CLOSED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  SupportMessage[]
}

model SupportMessage {
  id        Int      @id @default(autoincrement())

  threadId  Int
  thread    SupportThread @relation(fields: [threadId], references: [id])

  sender    String   // "USER" | "ADMIN"
  body      String

  createdAt DateTime @default(now())
}
